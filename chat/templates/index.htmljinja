<!doctype html>
<html>
<head>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/assets/style.styl"></link>
  <link rel="stylesheet" href="/assets/pygments.styl"></link>
  <link rel="stylesheet" href="/assets/tipsy_styles.styl"></link>
  <link rel="stylesheet" href="/static/css/ss-standard.css"></link>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href='http://fonts.googleapis.com/css?family=Cousine:400,700,400italic,700italic'
        rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Oswald:700' rel='stylesheet' type='text/css'>
  <script src="/static/js/jquery-1.8.0.min.js"></script>
  <script src="/static/js/jquery.hotkeys.js"></script>
  <script src="/static/js/bootstrap-alert.js"></script>
  <script src="/static/js/mustache.js"></script>
  <script src="/static/js/underscore-1.3.3-min.js"></script>
  <script src="/static/js/backbone-0.9.2-min.js"></script>
  <script src="/static/js/jquery.tipsy.js"></script>
  {% if debug %}
  <script src="/static/js/livecss.js"></script>
  {% endif %}
  <script src="/assets/util.coffee"></script>
  <script src="/assets/message_hub.coffee"></script>
  <script src="/assets/chat.coffee"></script>
  <script src="/assets/chat_controls.coffee"></script>
  <script src="/assets/channel_controls.coffee"></script>
  <script src="/assets/datetime.coffee"></script>
  <script src="/assets/sound.coffee"></script>
  <script src="/assets/alert.coffee"></script>
  <script src="/assets/user_statuses.coffee"></script>
  <script id="message-container-template" type="text/x-mustache-template">
    {{ message_container_template|safe }}
  </script>
  <script id="message-partial-template" type="text/x-mustache-template">
    {{ message_partial_template|safe }}
  </script>
  <script id="alert-template" type="text/x-mustache-template">
    {{ alert_template|safe }}
  </script>
  <script id="user-status-template" type="text/x-mustache-template">
    {{ user_status_template|safe }}
  </script>
  <script id="channel-button-template" type="text/x-mustache-template">
    {{ channel_button_template|safe }}
  </script>
  <script charset="utf-8">
    $(document).ready(function() {
      CurrentUserEmail = {{ email|tojson|safe }}
      var initialMessages = {{ initial_messages|tojson|safe }}
      var initialUsers = {{ initial_users|tojson|safe }}
      var initialChannel = {{ last_selected_channel|tojson|safe }}
      var initialChannels = {{ channels|tojson|safe }}

      messageHub = new MessageHub("ws://" + document.location.host + "/eventhub", 4000, new AlertHelper())

      channelViewCollection = new ChannelViewCollection({ currentChannel: initialChannel,
        messageHub: messageHub, channels: initialChannels })
      channelUsers = new ChannelUsers(messageHub, initialUsers, initialChannel, channelViewCollection)
      chatControls = new ChatControls(messageHub,
                                      channelViewCollection,
                                      {{ left_sidebar_closed|tojson }},
                                      {{ right_sidebar_closed|tojson }})

      sound = new Sound("/static/audio/ping.mp3")

      dateTimeHelper = new DateTimeHelper()

      messagesViewCollection = new MessagesViewCollection({ messageHub: messageHub,
                                                            sound: sound,
                                                            channels: initialChannels,
                                                            channelViewCollection: channelViewCollection,
                                                            username: {{ username|tojson|safe }},
                                                            dateTimeHelper: dateTimeHelper,
                                                            collapseTimeWindow: {{ time_window }},
                                                            title: {{ title|tojson|safe }},
                                                          })

      messagesViewCollection.appendInitialMessages(initialMessages)

      // Load up tipsy tooltips
      var default_tipsy_options = { opacity: 0.95, live: true };
      $(".north[rel=tipsy]").tipsy($.extend({}, default_tipsy_options, {gravity: "n"}));
      $(".south[rel=tipsy]").tipsy($.extend({}, default_tipsy_options, {gravity: "s"}));
      $(".east[rel=tipsy]").tipsy($.extend({}, default_tipsy_options, {gravity: "e"}));
      $(".west[rel=tipsy]").tipsy($.extend({}, default_tipsy_options, {gravity: "w"}));
    })
    $(window).load(function() { Util.scrollToBottom("noAnimate") })
  </script>
</head>
<body>
  <div class="left-sidebar {{ "closed" if left_sidebar_closed else "" }}">
    <div class="logo-title">
      <div>{{ title }}</div>
    </div>
    <div class="channel-controls-container">
      <div class="add-channel-container">
        <div class="plus-label">+</div>
        <input type="text" size="17" class="new-channel-name" />
      </div>
    </div>
  </div>
  <div class="main-content {{ "collapse-left" if left_sidebar_closed else "" }}">
    <div class="chat-column {{ "collapse-right" if right_sidebar_closed else "" }}">
      <div class="alert-container"></div>
      <div class="chat-controls">
        <button class="toggle-left-sidebar">
          <span class="ss-icon">{{"right" if left_sidebar_closed else "left"}}</span>
        </button>
        <div class="control-button-container">
          <button id="quicksend" class="active north" rel="tipsy">
            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 30 30" preserveAspectRatio="xMinYMin meet">
              <g id="lightning">
	              <path d="m 13.72,20.5 c 0.055,-0.27 -0.127,-0.49 -0.402,-0.49 h -1.477 c -0.275,0 -0.438,-0.216 -0.359,-0.479 l 1.295,-5.047 c 0.076,-0.264 -0.084,-0.479 -0.359,-0.479 h -2.529 c -0.275,0 -0.43,-0.214 -0.346,-0.476 l 3.348,-10.049 c 0.086,-0.262 0.381,-0.476 0.654,-0.476 h 6.607 c 0.275,0 0.402,0.203 0.283,0.45 l -4.08,7.131 c -0.119,0.248 0.008,0.448 0.283,0.445 l 2.529,-0.026 c 0.275,0 0.398,0.195 0.275,0.441 l -2.426,6.143 c -0.123,0.246 0.002,0.447 0.277,0.447 h 1.498 c 0.273,0 0.361,0.178 0.191,0.395 l -6.379,8.436 c -0.168,0.217 -0.264,0.174 -0.209,-0.096 l 1.326,-6.27 z"/>
              </g>
            </svg>
          </button>
          <a href="{{ url_for("auth.logout") }}">
            <button id="logout" class="north" rel="tipsy" title="Logout">
              <span class="ss-icon">logout</span>
            </button>
          </a>
        </div>
        <button class="toggle-right-sidebar">
          <span class="ss-icon">{{ "left" if right_sidebar_closed else "right" }}</span>
        </button>
        <div class="channel-name">{{ last_selected_channel }}</div>
      </div>
      <div class="input-container">
        <div class="chat-text-wrapper"><textarea class="chat-text"></textarea></div>
        <div class="preview-wrapper" style="display:none"><div class="message"></div></div>
        <div class="input-controls">
          <button class="chat-submit">Send</button>
          <button class="chat-preview">Preview</button>
          <button class="chat-edit" style="display:none">Edit</button>
        </div>
      </div>
    </div>
  </div>
  <div class="right-sidebar {{ "closed" if right_sidebar_closed else "" }}">
  </div>
</body>
</html>

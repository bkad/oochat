<!doctype html>
<html>
<head>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/assets/style.styl"></link>
  <link rel="stylesheet" href="/static/css/ss-standard.css"></link>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script src="/static/js/jquery.hotkeys.js"></script>
  <script src="/static/js/bootstrap-alert.js"></script>
  <script src="/static/js/mustache.js"></script>
  <script src="/static/js/livecss.js"></script>
  <script src="/static/js/underscore-1.3.3-min.js"></script>
  <script src="/static/js/backbone-0.9.2-min.js"></script>
  <script src="/assets/util.coffee"></script>
  <script src="/assets/message_hub.coffee"></script>
  <script src="/assets/chat.coffee"></script>
  <script src="/assets/chat_controls.coffee"></script>
  <script src="/assets/channel_controls.coffee"></script>
  <script src="/assets/datetime.coffee"></script>
  <script src="/assets/sound.coffee"></script>
  <script src="/assets/alert.coffee"></script>
  <script src="/assets/user_statuses.coffee"></script>
  <script id="message-container-template" type="text/x-mustache-template">
    {{ message_container_template|safe }}
  </script>
  <script id="message-partial-template" type="text/x-mustache-template">
    {{ message_partial_template|safe }}
  </script>
  <script id="alert-template" type="text/x-mustache-template">
    {{ alert_template|safe }}
  </script>
  <script id="user-status-template" type="text/x-mustache-template">
    {{ user_status_template|safe }}
  </script>
  <script charset="utf-8">
    $(document).ready(function() {
      initialMessages = {{ initial_messages|tojson|safe }}
      initialUsers = {{ initial_users|tojson|safe }}
      initialChannel = {{ last_selected_channel|tojson|safe }}

      messageHub = new MessageHub("ws://" + document.location.host + "/eventhub", 4000, new AlertHelper())
      messageHub.init()

      channelUsers = new ChannelUsers(messageHub)
      channelUsers.init(initialUsers, initialChannel)

      sound = new Sound("/static/audio/ping.mp3")
      sound.init()

      dateTimeHelper = new DateTimeHelper()
      channelControls = new ChannelControls({{ last_selected_channel|tojson|safe }}, messageHub, channelUsers)
      chat = new Chat(messageHub,
                      {{ time_window }},
                      channelControls,
                      dateTimeHelper,
                      {{ username|tojson|safe }},
                      sound)
      chatControls = new ChatControls(messageHub)

      chat.init()
      chatControls.init({{ left_sidebar_closed|lower }}, {{ right_sidebar_closed|lower }})
      channelControls.init()
      dateTimeHelper.init()

      chat.appendInitialMessages(initialMessages)
    })
    $(window).load(function() { Util.scrollToBottom("noAnimate") })
  </script>
</head>
<body>
  <div class="left-sidebar {{ "closed" if left_sidebar_closed else "" }}">
    <div class="logo-title">
      <div>{{ "".join(name_jumble[:2]) }}</div>
      <div>{{ "".join(name_jumble[2:]) }}</div>
    </div>
    <div class="channel-list-container">
      {% for channel in channels %}
        <button class="channel {{ "current" if channel == last_selected_channel else "" }}"
          data-channel-name="{{ channel }}">{{ channel }}</button>
      {% endfor %}
      <div class="add-channel-container">
        <div class="plus-label">+</div>
        <input type="text" size="17" class="new-channel-name" />
      </div>
    </div>
  </div>
  <div class="main-content {{ "collapse-left" if left_sidebar_closed else "" }}">
    <div class="chat-column {{ "collapse-right" if right_sidebar_closed else "" }}">
      <div class="alert-container"></div>
      <div class="chat-controls">
        <button class="toggle-left-sidebar">
          <span class="ss-icon">{{"right" if left_sidebar_closed else "left"}}</span>
        </button>
        <button class="toggle-right-sidebar">
          <span class="ss-icon">{{ "left" if right_sidebar_closed else "right" }}</span>
        </button>
        <div class="channel-name">{{ last_selected_channel }}</div>
      </div>
      {% for channel in channels %}
        <div class="chat-messages-container {{ "current" if channel == last_selected_channel else "" }}"
          data-channel="{{ channel }}">
        </div>
      {% endfor %}
      <div class="input-container">
        <div class="chat-text-wrapper"><textarea class="chat-text"></textarea></div>
        <div class="input-controls">
          <button class="chat-submit">Send</button>
          <button class="chat-preview">Preview</button>
        </div>
      </div>
    </div>
    <div class="right-sidebar {{ "closed" if right_sidebar_closed else "" }}">
      <div class="user-container">
        <div class="user-data">
          <img height="18" width="18" class="gravatar" src="{{ avatar_url }}">
          <div class="full-name">{{ full_name }}</div>
          {% if authed %}
          <a href="{{ url_for("auth.logout") }}"><button class="logout">Logout</button></a>
          {% else %}
          <a href="{{ url_for("auth.login") }}"><button class="login">Login</button></a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</body>
</html>
